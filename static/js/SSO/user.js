// Generated by CoffeeScript 1.8.0
(function() {
  var $$user, focus, jump, login_o, mail_success, prefix, render, sso_submit, _, _user_new, _view_render;

  sso_submit = function(path, v, callback) {
    return $.ajax_submit("" + CONST.SSO.URL + "/rpc/user." + path + "?callback=?", v, callback);
  };

  _ = $.html();

  _view_render = function(action, title, html) {
    return _("<div ms_if=\"action=='" + action + "'\"><form ms_view=\"SSO_user_" + action + "\" class=\"login\" ms_submit=\"submit\"><h2>" + title + "</h2>" + html + "</form></div>");
  };

  _(" <div ms_view=\"SSO_user\" id=\"SSO_user\"><div id=\"login\"><span class=\"logo\"></span><div class=\"wrap\">\n<div ms_if=\"action=='mail_success'\">\n<div class=\"login success\" ms_view=\"SSO_user_mail_success\">\n<div class=\"tip\">{{tip}}</div>\n<div class=\"loginItem\">\n<a ms_href=\"http://{{url}}\" class=\"button\" target=\"_blank\">点击邮箱验证</a>\n</div>\n</div>\n</div>");

  _view_render("password_reset_apply", "发送邮件重置密码", "<input class=\"mail\" autocomplete=\"off\" type=\"email\"  ms_duplex=\"o.mail\" placeholder=\"邮箱地址\" name=\"mail\">\n<div class=\"signupItem\">\n<button href=\"javascript:void(0)\" ms_click=\"submit\" typr=\"submit\" class=\"button\">发送重置密码邮件</button>\n<a href=\"javascript:void(0)\" class=\"back\" ms_click=\"login\">登录&gt;&gt;</a>\n</div>");

  _view_render("new_by_mail", "使用邮箱地址注册", "<input class=\"mail\" name=\"mail\" ms_duplex=\"o.mail\" autocomplete=\"off\" type=\"email\" placeholder=\"邮箱地址\">\n<div class=\"loginItem\">\n<button href=\"javascript:void(0)\" ms_click=\"submit\" type=\"submit\" class=\"button\">注册</button>\n<a href=\"javascript:void(0)\" class=\"back\" ms_click=\"login\">已有账号&gt;&gt;</a>\n</div>");

  _view_render("login", "使用邮箱地址登录", "<input class=\"mail\" type=\"email\" autocomplete=\"off\"  ms_duplex=\"o.account\" placeholder=\"邮箱地址\" name=\"account\">\n<input class=\"password\" autocomplete=\"off\" type=\"password\" ms_duplex=\"o.password\"  placeholder=\"密码\" name=\"password\">\n<div class=\"signupItem checkItem\">\n<div class=\"checkboxItem\">\n<input type=\"checkbox\" id=\"SSO_user_login_forever\" ms_duplex_radio=\"o.forever\"><label for=\"SSO_user_login_forever\">记住我</label>\n</div>\n<a class=\"forget\" href=\"javascript:void(0)\" ms_click=\"password_reset_apply\">忘记密码</a>\n</div>\n<div class=\"signupItem\">\n<button href=\"javascript:void(0)\" type=\"submit\" ms_click=\"submit\" class=\"button\">登录</button>\n<a href=\"javascript:void(0)\" class=\"back\" ms_click=\"new_by_mail\">注册新账号&gt;&gt;</a>\n</div>");

  mail_success = function(v, tip) {
    var mail;
    mail = v.o.mail;
    V.SSO_user.action = "mail_success";
    V.SSO_user_mail_success.tip = "" + tip + "邮件已发送，请注意查收。";
    return V.SSO_user_mail_success.url = v.o.mail.split("@")[1];
  };

  focus = function() {
    return $("#SSO_user input:enabled:first").focus().select();
  };

  prefix = "//" + CONST.HOST + "/";

  jump = function(v, action) {
    return v[action] = function() {
      return V.SSO_user.action = action;
    };
  };

  login_o = {
    app_id: CONST.SSO.ID,
    password: ''
  };

  render = function(action, url, callback) {
    var HTML;
    _("</div></div></div>");
    HTML = _.html();
    return $.fancybox({
      content: HTML,
      afterShow: function() {
        return focus();
      },
      afterClose: function() {
        if (url) {
          return location.href = "/";
        }
      },
      beforeShow: function() {
        def_view("SSO_user", function(v) {
          v.action = action;
          return v.$watch("action", focus);
        });
        def_view("SSO_user_login", function(v) {
          v.o = $.extend({
            account: $.cookie.get('E') || '',
            forever: 1
          }, login_o);
          jump(v, "new_by_mail");
          jump(v, "password_reset_apply");
          return v.submit = sso_submit("login", v, function(r) {
            $.cookie.set({
              'E': v.o.account
            });
            $.fancybox.close();
            if (!url) {
              return location.reload();
            }
          });
        });
        def_view("SSO_user_new_by_mail", function(v) {
          v.o = {
            app_id: CONST.SSO.ID,
            mail: '',
            url: "" + prefix + "sso/mail_verify/"
          };
          v.submit = sso_submit("user_new_apply_by_mail", v, function(r) {
            return mail_success(v, "注册");
          });
          return jump(v, "login");
        });
        def_view("SSO_user_mail_success", function(v) {
          v.tip = "";
          return v.url = "";
        });
        def_view("SSO_user_password_reset_apply", function(v) {
          v.o = {
            app_id: CONST.SSO.ID,
            mail: '',
            url: "" + prefix + "sso/password_reset/"
          };
          jump(v, "login");
          return v.submit = sso_submit('password_reset_apply', v, function(data) {
            return mail_success(v, "密码重置");
          });
        });
        return typeof callback === "function" ? callback() : void 0;
      }
    });
  };

  $$user = $import("" + CONST.SSO.URL + "/rpc/user");

  $.SSO.user = {
    "new": function(url) {
      return render('new_by_mail', url);
    },
    login: function(url) {
      return render('login', url);
    },
    logout: function(url) {
      return $$user("logout", function() {
        $.cookie.set({
          S: 0
        }, {
          expires: -1
        });
        return location.reload();
      });
    }
  };

  _user_new = function(action, prepare, callback) {
    prepare();
    return $.SSO.user[action] = function(code) {
      return $$user(action, [CONST.SSO.ID, code], function(r) {
        return render(action, "/", function() {
          return callback(code, r.mail);
        });
      });
    };
  };

  _user_new("mail_verify", function() {
    return _view_render("mail_verify", "创建帐号", "<form ms_submit=\"submit\">\n<input disabled style=\"background-color:#ddd\" class=\"mail\" ms_duplex=\"mail\" autocomplete=\"off\" type=\"email\" placeholder=\"邮箱地址\" name=\"mail\">\n<input class=\"name\" name=\"name\" ms_duplex=\"o.name\" autocomplete=\"off\" placeholder=\"用户名称\">\n<input class=\"password\" name=\"password\" autocomplete=\"off\" type=\"password\" ms_duplex=\"o.password\" placeholder=\"密码\">\n<div class=\"loginItem\">\n<button type=\"submit\" class=\"button\">开始使用</button>\n<a href=\"/sso/login\" class=\"back\">已有账号&gt;&gt;</a>\n</div></form>");
  }, function(code, mail) {
    return def_view("SSO_user_mail_verify", function(v) {
      v.o = $.extend({
        code: code,
        name: ''
      }, login_o);
      v.mail = mail;
      return v.submit = sso_submit("ob_new_by_mail", v, function(r) {
        return $.fancybox.close();
      });
    });
  });

  _user_new("password_reset", function() {
    _view_render("password_reset", "重置密码", "<form ms_submit=\"submit\">\n<input disabled style=\"background-color:#ddd\" class=\"mail\" ms_duplex=\"mail\" autocomplete=\"off\" type=\"email\" placeholder=\"邮箱地址\">\n<input class=\"password\" autocomplete=\"off\" type=\"password\" ms_duplex=\"o.password\"  placeholder=\"密码\" name=\"password\">\n<div class=\"signupItem\">\n<button href=\"javascript:void(0)\" type=\"submit\" class=\"button\">重置密码</button>\n<a href=\"javascript:void(0)\" class=\"back\" ms_click=\"login\">登录&gt;&gt;</a>\n</div></form>");
    return _("<div ms_if=\"action=='password_reset_error'\">\n<div class=\"login success\" ms_view=\"SSO_user_password_reset_error\">\n<div class=\"tip\">密码重置链接已失效</div>\n<div class=\"loginItem\">\n<a href=\"javascript:void(0)\" ms_click=\"password_reset_apply\" class=\"button\">重新找回</a>\n</div>\n</div>\n</div>\n<div ms_if=\"action=='password_reset_success'\">\n<div class=\"login success\" ms_view=\"SSO_user_password_reset_success\">\n<div class=\"tip\">密码重置成功</div>\n<div class=\"loginItem\">\n<a href=\"javascript:void(0)\" ms_click=\"login\" class=\"button\">点击此登录</a>\n</div>\n</div>\n</div>");
  }, function(code, mail) {
    def_view("SSO_user_password_reset_error", function(v) {
      return jump(v, "password_reset_apply");
    });
    def_view("SSO_user_password_reset_success", function(v) {
      return jump(v, "login");
    });
    return def_view("SSO_user_password_reset", function(v) {
      if (!mail) {
        V.SSO_user.action = "password_reset_error";
        return;
      }
      v.o = {
        app_id: CONST.SSO.ID,
        code: code,
        password: ''
      };
      v.mail = mail;
      v.submit = sso_submit("password_set", v, function(r) {
        return V.SSO_user.action = "password_reset_success";
      });
      return jump(v, "login");
    });
  });

}).call(this);
